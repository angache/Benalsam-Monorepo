import{j as e}from"./query-tMv1bFhv.js";import{d as J,u as F,r as l,L as W}from"./router-Bq68dJ36.js";import{s as Q,l as X,A as z,j as E,k as B,m as Y,I as q,n as Z,o as ee,p as te,q as se,r as ae,t as re,B as ie}from"./listings-CDgdt6vp.js";import{d as K,s as $,B as k,t as M}from"./auth-Dm-7ngQy.js";import{a as j}from"./images-C3EucWOq.js";import{c as G,aL as P,L as I,a7 as ne,a as O,m as T,U as oe,N as le,aM as ce,aN as de,k as H,a5 as me}from"./ui-YP8xOIYG.js";const ue=({status:s,isCurrentUser:h})=>{if(!h)return null;const t="w-4 h-4",m=2.5;switch(s){case"sent":return e.jsx(G,{className:j(t,"text-black dark:text-gray-400"),strokeWidth:m});case"delivered":return e.jsx(P,{className:j(t,"text-black dark:text-gray-400"),strokeWidth:m});case"read":return e.jsx(P,{className:j(t,"text-orange-700 dark:text-orange-500"),strokeWidth:m});default:return e.jsx(G,{className:j(t,"text-black dark:text-gray-400"),strokeWidth:m})}},xe=()=>{const{conversationId:s}=J(),h=F(),{currentUser:t}=K(),[m,d]=l.useState([]),[u,x]=l.useState(""),[r,v]=l.useState(null),[y,C]=l.useState(!0),[_,i]=l.useState(!1),N=l.useRef(null),S=l.useRef(null),L=l.useRef(null),A=l.useRef(null),D=(a="smooth")=>{N.current?.scrollIntoView({behavior:a})},R=async()=>{t&&s&&await se(s,t.id)};l.useEffect(()=>{if(!t||!s)return;(async()=>{C(!0);const n=await Z(s);if(n){if(!n.conversation_participants?.some(c=>c.user_id===t.id)){M({title:"Yetkisiz EriÅŸim",description:"Bu sohbete eriÅŸim yetkiniz yok.",variant:"destructive"}),h(-1),C(!1);return}v(n);const o=await ee(s);d(o||[]),await R(),setTimeout(()=>D("auto"),100)}else M({title:"Sohbet BulunamadÄ±",description:"Bu sohbet mevcut deÄŸil veya eriÅŸim yetkiniz yok.",variant:"destructive"}),h("/aldigim-teklifler");C(!1)})()},[s,t?.id]),l.useEffect(()=>{if(!t||!s||y)return;const a=o=>{const c=S.current,g=c?c.scrollHeight-c.scrollTop-c.clientHeight<150:!0;d(f=>{if(f.some(b=>b.id===o.id))return f.map(b=>b.id===o.id?{...b,...o,status:o.status||b.status}:b);if(o.sender_id===t.id){const b=f.findLastIndex(U=>U.id.toString().startsWith("optimistic-"));if(b!==-1){const U=[...f];return U[b]={...o,status:"delivered"},U}}return[...f,o]}),g&&setTimeout(()=>D("smooth"),50),o.sender_id!==t.id&&document.visibilityState==="visible"&&R()},n=o=>{d(c=>c.map(g=>g.id===o.id?{...g,status:o.status,read_at:o.read_at}:g))};L.current=Q(s,a),A.current=X(s,n);const p=()=>{document.visibilityState==="visible"&&R()};return document.addEventListener("visibilitychange",p),window.addEventListener("focus",p),()=>{L.current&&($.removeChannel(L.current),L.current=null),A.current&&($.removeChannel(A.current),A.current=null),document.removeEventListener("visibilitychange",p),window.removeEventListener("focus",p)}},[s,t?.id,y]);const V=async a=>{if(a.preventDefault(),!u.trim()||!t||_)return;i(!0);const n=u.trim(),p=`optimistic-${Date.now()}`;x("");const o={id:p,conversation_id:s,sender_id:t.id,content:n,created_at:new Date().toISOString(),status:"sent",sender:{id:t.id,name:t.user_metadata?.name||t.email,avatar_url:t.user_metadata?.avatar_url||t.avatar_url}};d(c=>[...c,o]),setTimeout(()=>D("smooth"),50);try{const c=await te(s,t.id,n);if(c)d(g=>g.map(f=>f.id===p?{...c,status:"delivered"}:f));else throw new Error("Message sending failed, service handled toast.")}catch(c){c.message!=="Message sending failed, service handled toast."&&M({title:"Mesaj GÃ¶nderilemedi",description:"LÃ¼tfen tekrar deneyin.",variant:"destructive"}),d(g=>g.filter(f=>f.id!==p)),x(n)}finally{i(!1)}},w=!r||!t?null:r.conversation_participants?.find(a=>a.user_id!==t.id)?.profiles;return y?e.jsxs("div",{className:"h-screen flex flex-col items-center justify-center bg-background",children:[e.jsx(I,{className:"w-16 h-16 animate-spin text-primary mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Sohbet yÃ¼kleniyor..."})]}):r?e.jsxs(T.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"flex flex-col h-screen bg-gradient-to-br from-background to-slate-900/50",children:[e.jsx("header",{className:"flex-shrink-0 bg-background/80 backdrop-blur-md shadow-sm p-3 border-b border-border",children:e.jsxs("div",{className:"max-w-4xl mx-auto flex items-center justify-between",children:[e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>h(-1),className:"mr-2 text-muted-foreground hover:text-foreground",children:e.jsx(O,{className:"w-5 h-5"})}),w&&e.jsxs(W,{to:`/profil/${w.id}`,className:"flex items-center gap-3 hover:opacity-80 transition-opacity overflow-hidden flex-1 min-w-0",children:[e.jsxs(z,{className:"w-10 h-10 border-2 border-primary/50 shrink-0",children:[e.jsx(E,{src:w.avatar_url,alt:w.name}),e.jsx(B,{children:w.name?.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:"overflow-hidden min-w-0",children:[e.jsx("h2",{className:"font-semibold text-sm text-foreground truncate",children:w.name}),r.listings&&e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:['"',r.listings.title,'" ilanÄ± iÃ§in']}),!r.listings&&r.offers?.inventory_items&&e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:['"',r.offers.inventory_items.name,'" Ã¼rÃ¼nÃ¼ hakkÄ±nda']})]})]}),!w&&e.jsxs("div",{className:"flex items-center gap-3 overflow-hidden flex-1 min-w-0",children:[e.jsx(z,{className:"w-10 h-10 border-2 border-primary/50 shrink-0",children:e.jsx(B,{children:e.jsx(oe,{className:"w-5 h-5"})})}),e.jsxs("div",{className:"overflow-hidden min-w-0",children:[e.jsx("h2",{className:"font-semibold text-sm text-foreground truncate",children:"Sohbet"}),r.listings&&e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:['"',r.listings.title,'" ilanÄ± iÃ§in']}),!r.listings&&r.offers?.inventory_items&&e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:['"',r.offers.inventory_items.name,'" Ã¼rÃ¼nÃ¼ hakkÄ±nda']})]})]}),e.jsx("div",{className:"flex items-center gap-2 shrink-0",children:r.listings&&e.jsx(k,{variant:"outline",size:"sm",asChild:!0,className:"hidden sm:inline-flex",children:e.jsxs(W,{to:`/ilan/${r.listing_id}`,children:[e.jsx(le,{className:"w-3.5 h-3.5 mr-1.5"})," Ä°lanÄ± GÃ¶r"]})})})]})}),e.jsx("main",{ref:S,className:"flex-1 overflow-y-auto p-4 space-y-4 bg-transparent",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[m.map(a=>{const n=a.sender_id===t.id;return e.jsx(T.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.2},className:j("flex mb-3 max-w-[80%] sm:max-w-[70%]",n?"ml-auto justify-end":"mr-auto justify-start"),children:e.jsxs("div",{className:"flex items-end gap-2",children:[!n&&a.sender&&e.jsxs(z,{className:"w-8 h-8 self-start shrink-0",children:[e.jsx(E,{src:a.sender.avatar_url,alt:a.sender.name}),e.jsx(B,{children:a.sender.name?.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:j("p-3 rounded-xl shadow-md text-sm whitespace-pre-wrap break-words",a.id?.toString().startsWith("optimistic-")&&"opacity-70",n?"bg-primary text-primary-foreground rounded-br-none":"bg-card text-card-foreground rounded-bl-none border border-border"),children:[e.jsx("p",{children:a.content}),e.jsxs("div",{className:j("flex items-center gap-1.5 text-xs mt-1",n?"text-primary-foreground/70 justify-end":"text-muted-foreground/70 justify-start"),children:[e.jsx("span",{children:Y(a.created_at)}),e.jsx(ue,{status:a.status,isCurrentUser:n})]})]}),n&&e.jsxs(z,{className:"w-8 h-8 self-start shrink-0",children:[e.jsx(E,{src:t.user_metadata?.avatar_url||t.avatar_url,alt:t.user_metadata?.name||t.email}),e.jsx(B,{children:(t.user_metadata?.name||t.email)?.charAt(0).toUpperCase()})]})]})},a.id)}),e.jsx("div",{ref:N})]})}),e.jsx("footer",{className:"flex-shrink-0 bg-background/80 backdrop-blur-md p-3 border-t border-border",children:e.jsxs("form",{onSubmit:V,className:"max-w-4xl mx-auto flex items-center gap-2",children:[e.jsx(k,{variant:"ghost",size:"icon",type:"button",className:"text-muted-foreground hover:text-primary",onClick:()=>M({title:"ðŸš§ Ã‡ok YakÄ±nda!",description:"Dosya ve gÃ¶rsel gÃ¶nderme Ã¶zelliÄŸi geliÅŸtirme aÅŸamasÄ±nda.",variant:"info"}),children:e.jsx(ce,{className:"w-5 h-5"})}),e.jsx(q,{type:"text",placeholder:"Bir mesaj yazÄ±n...",value:u,onChange:a=>x(a.target.value),className:"flex-1 bg-input/50 focus:bg-input/80 border-border focus:ring-primary",disabled:_}),e.jsx(k,{type:"submit",size:"icon",className:"bg-primary hover:bg-primary/90 text-primary-foreground",disabled:_||!u.trim(),children:_?e.jsx(I,{className:"w-5 h-5 animate-spin"}):e.jsx(de,{className:"w-5 h-5"})})]})})]}):e.jsxs("div",{className:"h-screen flex flex-col items-center justify-center bg-background p-4",children:[e.jsx(ne,{className:"w-16 h-16 text-destructive mb-4"}),e.jsx("p",{className:"text-xl font-semibold text-center mb-2",children:"Sohbet Bilgisi BulunamadÄ±"}),e.jsx("p",{className:"text-muted-foreground text-center mb-6",children:"Bu sohbet mevcut olmayabilir veya eriÅŸim izniniz olmayabilir."}),e.jsxs(k,{onClick:()=>h(-1),variant:"outline",children:[e.jsx(O,{className:"w-4 h-4 mr-2"})," Geri DÃ¶n"]})]})},ke=Object.freeze(Object.defineProperty({__proto__:null,default:xe},Symbol.toStringTag,{value:"Module"})),he=({conversation:s,currentUser:h,onClick:t,unreadCount:m})=>{const d=s.user1_id===h.id?s.user2:s.user1,u=s.last_message,x=m>0;return e.jsxs(T.div,{whileHover:{scale:1.02},className:"flex items-center p-3 space-x-4 rounded-lg cursor-pointer transition-colors duration-200 bg-card hover:bg-card/80 border border-border",onClick:t,children:[e.jsxs("div",{className:"relative",children:[e.jsxs(z,{className:"w-12 h-12 border-2 border-primary/30",children:[e.jsx(E,{src:d?.avatar_url,alt:d?.name||"KullanÄ±cÄ±"}),e.jsx(B,{children:d?.name?.charAt(0).toUpperCase()||"?"})]}),x&&e.jsx(ie,{className:"absolute -top-1 -right-2 flex h-5 w-5 items-center justify-center rounded-full bg-primary text-primary-foreground text-xs p-0",children:m>9?"9+":m})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("p",{className:j("font-semibold text-sm truncate",x?"text-primary":"text-foreground"),children:d?.name||"Bilinmeyen KullanÄ±cÄ±"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:Y(u?.created_at||s.updated_at)})]}),e.jsx("p",{className:"text-xs text-muted-foreground truncate mb-1",children:s.listing?.title||"Ä°lan bilgisi yok"}),e.jsx("p",{className:j("text-xs truncate",x?"text-foreground font-medium":"text-muted-foreground"),children:u?e.jsxs(e.Fragment,{children:[u.sender_id===h.id&&"Siz: ",u.content]}):"Sohbeti baÅŸlat..."})]})]})},fe=()=>{const[s,h]=l.useState([]),[t,m]=l.useState({}),[d,u]=l.useState(!0),[x,r]=l.useState(""),{currentUser:v}=K(),y=F();l.useEffect(()=>{v&&(async()=>{u(!0);const[N,S]=await Promise.all([ae(v.id),re(v.id)]);N?h(N):M({title:"Sohbetler YÃ¼klenemedi",description:"Sohbetlerinizi alÄ±rken bir sorun oluÅŸtu. LÃ¼tfen tekrar deneyin.",variant:"destructive"}),m(S||{}),u(!1)})()},[v]);const C=s.filter(i=>{const N=i.user1_id===v.id?i.user2:i.user1,S=i.listing?.title||"",L=i.last_message?.content||"";return N?.name?.toLowerCase().includes(x.toLowerCase())||S.toLowerCase().includes(x.toLowerCase())||L.toLowerCase().includes(x.toLowerCase())}),_=()=>{y(-1)};return e.jsxs(T.div,{initial:{opacity:0},animate:{opacity:1},className:"max-w-2xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx(k,{variant:"ghost",size:"icon",onClick:_,className:"mr-4 text-muted-foreground hover:text-foreground",children:e.jsx(O,{className:"w-5 h-5"})}),e.jsxs("h1",{className:"text-2xl font-bold text-gradient flex items-center",children:[e.jsx(H,{className:"mr-3 w-7 h-7"}),"MesajlarÄ±m"]})]}),e.jsxs("div",{className:"relative mb-6",children:[e.jsx(me,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground"}),e.jsx(q,{type:"text",placeholder:"Sohbetlerde ara...",className:"pl-10 pr-4 py-2 w-full bg-input border-border",value:x,onChange:i=>r(i.target.value)})]}),d?e.jsx("div",{className:"flex justify-center items-center py-20",children:e.jsx(I,{className:"w-8 h-8 animate-spin text-primary"})}):C.length>0?e.jsx("div",{className:"space-y-3",children:C.map(i=>e.jsx(he,{conversation:i,currentUser:v,unreadCount:t[i.id]||0,onClick:()=>y(`/mesajlar/${i.id}`)},i.id))}):e.jsxs("div",{className:"text-center py-20",children:[e.jsx(H,{className:"mx-auto w-16 h-16 text-muted-foreground/50 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"HenÃ¼z hiÃ§ sohbetiniz yok"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:"Bir ilana teklif yaptÄ±ÄŸÄ±nÄ±zda veya teklif aldÄ±ÄŸÄ±nÄ±zda sohbetleriniz burada gÃ¶rÃ¼necektir."}),e.jsx(k,{onClick:()=>y("/"),className:"mt-6",children:"Ä°lanlara GÃ¶z At"})]})]})},Ce=Object.freeze(Object.defineProperty({__proto__:null,default:fe},Symbol.toStringTag,{value:"Module"}));export{ke as C,Ce as a};
