import{j as e}from"./query-tMv1bFhv.js";import{u as q,r as m,d as W}from"./router-Bq68dJ36.js";import{e as Y,t as z,s as Z,B as S}from"./auth-CRgK8rPx.js";import{ay as _,aB as ee,S as U,w as L,x as O,y as P,z as $,aC as ae,aD as K}from"./listings-BLmNnY3e.js";import{a1 as te,a2 as se,o as ne,S as G,a3 as ie,Y as M,m as B,A as re,i as le,B as oe,a7 as de,al as ce}from"./ui-DwxUvrnm.js";import"./vendor-Bs7gn1Hv.js";import"./supabase-D6FkHI3a.js";const me=n=>{const x=q(),{currentUser:d,handleAddInventoryItem:p,handleUpdateInventoryItem:y,isUploading:b,uploadProgress:f}=Y(),g=!!n,j={name:"",description:"",images:[],mainImageIndex:-1},[u,r]=m.useState(j),[v,t]=m.useState(""),[s,c]=m.useState(""),[l,I]=m.useState(""),[N,w]=m.useState({}),[C,k]=m.useState(g);m.useEffect(()=>{g&&d?(async()=>{k(!0);const{data:a,error:h}=await Z.from("inventory_items").select("*").eq("id",n).eq("user_id",d.id).single();if(h||!a){z({title:"Ürün Bulunamadı",description:"Düzenlenecek ürün bulunamadı veya size ait değil.",variant:"destructive"}),x("/envanterim");return}const o=[];a.main_image_url&&o.push({preview:a.main_image_url,name:"main_image.jpg",isUploaded:!0,url:a.main_image_url}),(a.additional_image_urls||[]).forEach((E,Q)=>{o.push({preview:E,name:`additional_image_${Q}.jpg`,isUploaded:!0,url:E})});const D=a.category?.split(" > ")||[];t(D[0]||""),c(D[1]||""),I(D[2]||""),r({id:a.id,name:a.name,description:a.description||"",images:o,mainImageIndex:o.length>0?o.findIndex(E=>E.url===a.main_image_url):-1}),k(!1)})():g?g&&!d&&k(!1):(r(j),t(""),c(""),I(""),w({}),k(!1))},[n,g,d,x]);const A=m.useCallback(i=>{const{name:a,value:h}=i.target;r(o=>({...o,[a]:h})),N[a]&&w(o=>({...o,[a]:""}))},[N]),T=m.useCallback(i=>{r(a=>{let h=a.mainImageIndex;return i.length===1&&a.mainImageIndex===-1?h=0:i.length===0?h=-1:a.mainImageIndex>=i.length&&(h=i.length>0?0:-1),{...a,images:i,mainImageIndex:h}})},[]),H=m.useCallback(i=>{r(a=>{const h=a.images.filter((D,E)=>E!==i);let o=a.mainImageIndex;return i===a.mainImageIndex?o=h.length>0?0:-1:i<a.mainImageIndex&&(o-=1),{...a,images:h,mainImageIndex:o}})},[]),X=m.useCallback(i=>{r(a=>({...a,mainImageIndex:i}))},[]),R=m.useCallback(()=>{const i={};u.name.trim()||(i.name="Ürün adı gerekli.");const a=_.find(o=>o.name===v),h=a?.subcategories?.find(o=>o.name===s);return v?a?.subcategories?.length>0&&!s?i.category="Alt kategori seçimi gerekli":h?.subcategories?.length>0&&!l&&(i.category="Detay kategori seçimi gerekli"):i.category="Ana kategori seçimi gerekli",u.images.length===0?i.images="En az bir görsel yüklemelisiniz.":u.mainImageIndex===-1&&u.images.length>0&&r(o=>({...o,mainImageIndex:0})),w(i),Object.keys(i).length===0},[u,v,s,l]),J=m.useCallback(async i=>{if(i.preventDefault(),b)return;if(!R()){z({title:"Form Hatalı",description:"Lütfen gerekli alanları doldurun, kategori seçimini tamamlayın ve en az bir görsel ekleyin.",variant:"destructive"});return}const a=ee(v,s,l),h={...u,category:a};let o;g?o=await y(h):o=await p(h),o&&x("/envanterim")},[b,R,u,v,s,l,g,y,p,x]);return{formData:u,setFormData:r,selectedMainCategory:v,setSelectedMainCategory:t,selectedSubCategory:s,setSelectedSubCategory:c,selectedSubSubCategory:l,setSelectedSubSubCategory:I,errors:N,loadingInitialData:C,isEditMode:g,isUploading:b,uploadProgress:f,handleChange:A,handleImageArrayChange:T,handleRemoveImageFromArray:H,handleSetMainImage:X,handleSubmit:J}},F=({label:n,icon:x,children:d,error:p})=>e.jsxs("div",{children:[e.jsxs("label",{htmlFor:d?.props?.id||d?.props?.name,className:"block text-sm font-medium text-foreground mb-1.5",children:[x&&e.jsx(x,{className:"w-4 h-4 inline mr-1.5 text-primary"})," ",n]}),d,p&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:p})]}),ge=({selectedMain:n,onMainChange:x,selectedSub:d,onSubChange:p,selectedSubSub:y,onSubSubChange:b,errors:f,disabled:g})=>{const[j,u]=m.useState([]),[r,v]=m.useState([]);return m.useEffect(()=>{if(n){const t=_.find(s=>s.name===n);u(t?.subcategories||[]),t?.subcategories?.find(s=>s.name===d)||p("")}else u([]),p("")},[n,p,d]),m.useEffect(()=>{if(d){const s=_.find(c=>c.name===n)?.subcategories?.find(c=>c.name===d);v(s?.subcategories||[]),s?.subcategories?.find(c=>c.name===y)||b("")}else v([]),b("")},[d,n,b,y]),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(U,{value:n,onValueChange:x,disabled:g,children:[e.jsx(L,{className:`w-full bg-input border-border text-foreground ${f?.category&&!n?"border-destructive":""}`,children:e.jsx(O,{placeholder:"Ana Kategori Seçin *"})}),e.jsx(P,{className:"dropdown-content",children:_.map(t=>e.jsx($,{value:t.name,children:t.name},t.name))})]}),n&&j.length>0&&e.jsxs(U,{value:d,onValueChange:p,disabled:g,children:[e.jsx(L,{className:`w-full bg-input border-border text-foreground ${f?.category&&!d?"border-destructive":""}`,children:e.jsx(O,{placeholder:"Alt Kategori Seçin *"})}),e.jsx(P,{className:"dropdown-content",children:j.map(t=>e.jsx($,{value:t.name,children:t.name},t.name))})]}),d&&r.length>0&&e.jsxs(U,{value:y,onValueChange:b,disabled:g,children:[e.jsx(L,{className:`w-full bg-input border-border text-foreground ${f?.category&&!y?"border-destructive":""}`,children:e.jsx(O,{placeholder:"Detay Kategori Seçin *"})}),e.jsx(P,{className:"dropdown-content",children:r.map(t=>e.jsx($,{value:t.name,children:t.name},t.name))})]}),f?.category&&e.jsx("p",{className:"text-destructive text-xs mt-1",children:f.category})]})},ue=({images:n,onImageChange:x,onRemoveImage:d,onSetMainImage:p,mainImageIndex:y,errors:b,maxImages:f,disabled:g})=>{const j=m.useRef(null),[u,r]=m.useState({isOpen:!1,image:null,index:-1}),v=async c=>{const l=Array.from(c.target.files);if(l.length===0)return;const I=l.slice(0,f-n.length);if(l.length>I.length&&z({title:"Görsel Limiti Aşıldı!",description:`En fazla ${f} görsel yükleyebilirsiniz.`,variant:"destructive"}),I.length>0){z({title:"Görseller optimize ediliyor...",description:"Lütfen bekleyin."});const N=await Promise.all(I.map(k=>K(k))),w=[...n];let C=0;N.forEach(k=>{const A=new FileReader;A.onloadend=()=>{w.push({file:k,preview:A.result,name:k.name,isUploaded:!1}),C++,C===N.length&&(x(w),z({title:"Görseller eklendi!",description:`${C} görsel başarıyla optimize edildi ve eklendi.`}))},A.readAsDataURL(k)})}j.current&&(j.current.value=null)},t=c=>{r({isOpen:!0,image:n[c],index:c})},s=async c=>{const{index:l}=u,I=await K(c),N=new FileReader;N.onloadend=()=>{const w=[...n];w[l]={file:I,preview:N.result,name:I.name,isUploaded:!1},x(w),z({title:"Görsel Güncellendi",description:"Görsel başarıyla düzenlendi ve optimize edildi."})},N.readAsDataURL(I),r({isOpen:!1,image:null,index:-1})};return e.jsxs("div",{children:[e.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-3",children:[n.map((c,l)=>e.jsxs("div",{className:"relative group aspect-square",children:[e.jsx("img",{src:c.preview,alt:`Önizleme ${l+1}`,className:"w-full h-full object-cover rounded-md border border-border"}),!g&&e.jsxs("div",{className:"absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-wrap items-center justify-center gap-1 p-1",children:[e.jsx(S,{type:"button",variant:"secondary",size:"icon",onClick:()=>t(l),className:"h-7 w-7",title:"Düzenle",children:e.jsx(te,{className:"w-3.5 h-3.5"})}),e.jsx(S,{type:"button",variant:"destructive",size:"icon",onClick:()=>d(l),className:"h-7 w-7",title:"Sil",children:e.jsx(se,{className:"w-3.5 h-3.5"})}),e.jsx(S,{type:"button",variant:y===l?"default":"secondary",size:"icon",onClick:()=>p(l),className:"h-7 w-7",title:"Ana görsel yap",children:y===l?e.jsx(ne,{className:"w-3.5 h-3.5 text-green-400"}):e.jsx(G,{className:"w-3.5 h-3.5"})})]}),y===l&&e.jsx("div",{className:"absolute top-1 right-1 bg-primary text-primary-foreground p-0.5 rounded-full",children:e.jsx(G,{className:"w-3 h-3 fill-current"})})]},l)),n.length<f&&!g&&e.jsxs(S,{type:"button",variant:"outline",onClick:()=>j.current&&j.current.click(),className:"w-full aspect-square flex flex-col items-center justify-center border-dashed border-primary/50 text-primary hover:bg-primary/10",children:[e.jsx(ie,{className:"w-6 h-6 mb-1"}),e.jsx("span",{className:"text-xs",children:"Yükle"})]})]}),e.jsx("input",{type:"file",accept:"image/jpeg,image/png,image/webp",multiple:!0,ref:j,onChange:v,className:"hidden",id:"inventoryImageUploadInput",disabled:g}),b?.images&&e.jsx("p",{className:"text-destructive text-xs mt-1",children:b.images}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[n.length," / ",f," görsel yüklendi. Ana görseli ",e.jsx(G,{className:"w-3 h-3 inline text-yellow-400 fill-current"})," ile işaretleyebilirsiniz."]}),u.isOpen&&e.jsx(ae,{isOpen:u.isOpen,onOpenChange:()=>r({isOpen:!1,image:null,index:-1}),image:u.image,onSave:s})]})},V=3,ve=()=>{const{itemId:n}=W(),x=q(),{loadingAuth:d}=Y(),{formData:p,selectedMainCategory:y,setSelectedMainCategory:b,selectedSubCategory:f,setSelectedSubCategory:g,selectedSubSubCategory:j,setSelectedSubSubCategory:u,errors:r,loadingInitialData:v,isEditMode:t,isUploading:s,uploadProgress:c,handleChange:l,handleImageArrayChange:I,handleRemoveImageFromArray:N,handleSetMainImage:w,handleSubmit:C}=me(n);return d?e.jsxs("div",{className:"min-h-screen flex items-center justify-center bg-background",children:[e.jsx(M,{className:"w-12 h-12 animate-spin text-primary"}),e.jsx("p",{className:"ml-4 text-muted-foreground",children:"Kimlik doğrulanıyor..."})]}):v?e.jsxs("div",{className:"min-h-screen flex items-center justify-center bg-background",children:[e.jsx(M,{className:"w-12 h-12 animate-spin text-primary"}),e.jsx("p",{className:"ml-4 text-muted-foreground",children:t?"Ürün bilgileri yükleniyor...":"Form hazırlanıyor..."})]}):e.jsxs(B.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"max-w-lg mx-auto px-4 py-12",children:[e.jsxs("div",{className:"flex items-center mb-8",children:[e.jsx(S,{variant:"ghost",size:"icon",onClick:()=>x(-1),className:"mr-4 text-muted-foreground hover:text-foreground",disabled:s,children:e.jsx(re,{className:"w-6 h-6"})}),e.jsx("h1",{className:"text-2xl font-bold text-gradient",children:t?"Ürünü Düzenle":"Yeni Ürün Ekle"})]}),e.jsxs("form",{onSubmit:C,className:"space-y-5 p-6 glass-effect rounded-2xl",children:[e.jsx(F,{label:"Ürün Adı *",icon:le,error:r.name,children:e.jsx("input",{type:"text",name:"name",id:"name",value:p.name,onChange:l,placeholder:"Örn: Eski Laptop",disabled:s,className:`w-full px-3 py-2.5 bg-input border rounded-lg focus:outline-none input-glow ${r.name?"border-destructive":"border-border"}`})}),e.jsx(F,{label:"Kategori Seçimi *",icon:oe,error:r.category,children:e.jsx(ge,{selectedMain:y,onMainChange:b,selectedSub:f,onSubChange:g,selectedSubSub:j,onSubSubChange:u,errors:r,disabled:s})}),e.jsx(F,{label:"Açıklama",icon:de,error:r.description,children:e.jsx("textarea",{name:"description",id:"description",value:p.description||"",onChange:l,placeholder:"Ürün hakkında kısa bilgi",rows:"3",disabled:s,className:"w-full px-3 py-2.5 bg-input border rounded-lg focus:outline-none input-glow resize-none border-border"})}),e.jsx(F,{label:`Ürün Görselleri (En az 1, En fazla ${V}) *`,icon:ce,error:r.images,children:e.jsx(ue,{images:p.images,onImageChange:I,onRemoveImage:N,onSetMainImage:w,mainImageIndex:p.mainImageIndex,errors:r,maxImages:V,disabled:s})}),s&&e.jsxs("div",{className:"mt-4",children:[e.jsx("div",{className:"relative w-full h-2 bg-muted rounded-full overflow-hidden",children:e.jsx(B.div,{className:"absolute top-0 left-0 h-full bg-primary",initial:{width:"0%"},animate:{width:`${c}%`},transition:{duration:.5,ease:"linear"}})}),e.jsxs("p",{className:"text-xs text-center text-muted-foreground mt-1",children:["Görseller yükleniyor: ",c,"%"]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[e.jsx(S,{type:"button",variant:"outline",onClick:()=>x(-1),disabled:s,className:"border-muted-foreground/50 text-muted-foreground hover:bg-muted-foreground/10",children:"İptal"}),e.jsx(S,{type:"submit",className:"btn-primary text-primary-foreground",disabled:s,children:s?e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"mr-2 h-4 w-4 animate-spin"}),t?"Kaydediliyor...":"Ekleniyor..."]}):t?"Kaydet":"Ekle"})]})]})]})};export{ve as default};
