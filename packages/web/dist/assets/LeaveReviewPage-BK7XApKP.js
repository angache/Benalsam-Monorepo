import{j as e}from"./query-tMv1bFhv.js";import{d as O,u as L,r as s}from"./router-Bq68dJ36.js";import{d as C,g as E,B as f,s as w}from"./auth-Dm-7ngQy.js";import{aL as _,aM as A,a1 as B,aO as D}from"./listings-BkJHjkUV.js";import{a as T}from"./images-C3EucWOq.js";import{L as H,m as P,a as G,S as I,aN as j}from"./ui-YP8xOIYG.js";import"./vendor-Bs7gn1Hv.js";import"./supabase-D6FkHI3a.js";const W=()=>{const{offerId:o}=O(),i=L(),{currentUser:n}=C(),{toast:t}=E(),[r,N]=s.useState(null),[g,p]=s.useState(!0),[c,S]=s.useState(0),[z,x]=s.useState(0),[v,R]=s.useState(""),[d,y]=s.useState(!1);if(s.useEffect(()=>{if(!n||!o)return;(async()=>{p(!0);try{const{data:l,error:m}=await w.from("offers").select(`
            listing_id,
            listings!offers_listing_id_fkey(user_id),
            offering_user_id,
            status
          `).eq("id",o).single();if(m||!l){console.error("Error fetching offer for review check or offer not found:",m),t({title:"Teklif Bulunamadı",description:"Değerlendirilecek teklif bulunamadı.",variant:"destructive"}),i(-1);return}if(l.status!=="accepted"){t({title:"Yorum Yapılamaz",description:"Sadece kabul edilmiş takaslar için yorum yapabilirsiniz.",variant:"info"}),i(-1);return}if(!await B(n.id,o)){t({title:"Yorum Yapılamaz",description:"Bu takas için daha önce yorum yapmışsınız veya yorum yapma yetkiniz yok.",variant:"info"}),i(-1);return}const{data:k,error:b}=await w.from("offers").select(`
            *,
            profiles:offering_user_id(id, name, avatar_url, rating, total_ratings),
            listings!offers_listing_id_fkey(
              id,
              title,
              main_image_url,
              image_url,
              budget,
              status,
              user_id,
              profiles:user_id(id, name, avatar_url, rating, total_ratings)
            )
          `).eq("id",o).single();if(b||!k){console.error("Error fetching full offer details:",b),t({title:"Teklif Detayları Alınamadı",description:"Teklif bilgileri yüklenirken bir hata oluştu.",variant:"destructive"}),i(-1);return}N(k),p(!1)}catch(l){console.error("Error in loadOfferAndCheckReviewability:",l),t({title:"Beklenmedik Hata",description:"Teklif bilgileri yüklenirken bir sorun oluştu.",variant:"destructive"}),i(-1)}})()},[n,o,i,t]),!r&&!g)return t({title:"Hata",description:"Yorum yapılacak teklif bilgisi alınamadı.",variant:"destructive"}),i(-1),null;const u=r?.offering_user_id===n?.id?r?.listings?.profiles:r?.profiles,h=u?.id,Y=async a=>{if(a.preventDefault(),c===0){t({title:"Puan Gerekli",description:"Lütfen 1-5 arası bir puan verin.",variant:"destructive"});return}if(!h){t({title:"Hata",description:"Yorum yapılacak kullanıcı bulunamadı.",variant:"destructive"});return}y(!0);const l={reviewer_id:n.id,reviewee_id:h,offer_id:r.id,rating:c,comment:v.trim()},m=await D(l);y(!1),m&&(t({title:"Yorum Gönderildi!",description:`${u.name} için yorumunuz kaydedildi.`}),i(r.offering_user_id===n.id?"/aldigim-teklifler":"/gonderdigim-teklifler"))};return g?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background",children:e.jsx(H,{className:"w-12 h-12 animate-spin text-primary"})}):e.jsxs(P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"max-w-lg mx-auto px-4 py-12",children:[e.jsxs("div",{className:"flex items-center mb-8",children:[e.jsx(f,{variant:"ghost",size:"icon",onClick:()=>i(-1),className:"mr-4 text-muted-foreground hover:text-foreground",disabled:d,children:e.jsx(G,{className:"w-6 h-6"})}),e.jsxs("h1",{className:"text-2xl font-bold text-gradient truncate",children:["Değerlendirme Yap: ",e.jsx("span",{className:"text-primary",children:u?.name||"Kullanıcı"})]})]}),e.jsxs("form",{onSubmit:Y,className:"space-y-6 p-6 glass-effect rounded-2xl",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:['Bu takas deneyiminizi değerlendirin. Yorumunuz diğer kullanıcılar için faydalı olacaktır. İlgili ilan: "',r?.listings?.title||"İlan Adı Yok",'"']}),e.jsxs("fieldset",{disabled:d,children:[e.jsxs("div",{children:[e.jsx(_,{htmlFor:"rating",className:"mb-2 block text-sm font-medium",children:"Puanınız *"}),e.jsx("div",{className:"flex items-center space-x-1",children:[1,2,3,4,5].map(a=>e.jsx(I,{className:T("w-8 h-8 cursor-pointer transition-colors",(z||c)>=a?"text-yellow-400 fill-yellow-400":"text-gray-400 hover:text-yellow-300"),onClick:()=>S(a),onMouseEnter:()=>x(a),onMouseLeave:()=>x(0)},a))})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(_,{htmlFor:"comment",className:"font-medium",children:"Yorumunuz (İsteğe Bağlı)"}),e.jsx(A,{id:"comment",placeholder:`${u?.name||"Kullanıcı"} ile takas deneyiminiz nasıldı?`,value:v,onChange:a=>R(a.target.value),className:"min-h-[120px] bg-input border-border"})]})]}),e.jsxs("div",{className:"flex gap-4 pt-3",children:[e.jsx(f,{type:"button",variant:"outline",onClick:()=>i(-1),disabled:d,className:"flex-1 border-muted-foreground/50 text-muted-foreground hover:bg-muted-foreground/10",children:"İptal"}),e.jsxs(f,{type:"submit",disabled:d||c===0,className:"flex-1 btn-primary text-primary-foreground",children:[d?e.jsx(j,{className:"w-4 h-4 mr-2 animate-pulse"}):e.jsx(j,{className:"w-4 h-4 mr-2"}),"Değerlendirmeyi Gönder"]})]})]})]})};export{W as default};
